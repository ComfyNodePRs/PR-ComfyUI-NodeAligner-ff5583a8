const alignBottomSvg = `<svg t="1725534360155" class="icon" viewBox="0 0 1170 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1662" width="100%"><path d="M1170.285714 987.428571a36.571429 36.571429 0 0 0-36.571428-36.571428H36.571429a36.571429 36.571429 0 0 0 0 73.142857h1097.142857a36.571429 36.571429 0 0 0 36.571428-36.571429z m-219.428571-146.285714v-512a36.571429 36.571429 0 0 0-36.571429-36.571428h-219.428571a36.571429 36.571429 0 0 0-36.571429 36.571428v512a36.571429 36.571429 0 0 0 36.571429 36.571429h219.428571a36.571429 36.571429 0 0 0 36.571429-36.571429z m-438.857143 0V36.571429a36.571429 36.571429 0 0 0-36.571429-36.571429h-219.428571a36.571429 36.571429 0 0 0-36.571429 36.571429v804.571428a36.571429 36.571429 0 0 0 36.571429 36.571429h219.428571a36.571429 36.571429 0 0 0 36.571429-36.571429z" fill="#666666" p-id="1663"></path></svg>`;
const alignCenterHorizontallySvg = `<svg t="1725534379860" class="icon" viewBox="0 0 1243 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2250" width="100%"><path d="M548.571429 472.356571h146.285714V231.643429a36.571429 36.571429 0 0 1 36.571428-36.571429h219.428572a36.571429 36.571429 0 0 1 36.571428 36.571429v240.713142h179.785143a39.643429 39.643429 0 0 1 0 79.286858H987.428571v240.713142a36.571429 36.571429 0 0 1-36.571428 36.571429h-219.428572a36.571429 36.571429 0 0 1-36.571428-36.571429V551.643429h-146.285714V950.857143a36.571429 36.571429 0 0 1-36.571429 36.571428H292.571429a36.571429 36.571429 0 0 1-36.571429-36.571428V551.643429H76.214857a39.643429 39.643429 0 1 1 0-79.286858H256V73.142857A36.571429 36.571429 0 0 1 292.571429 36.571429h219.428571a36.571429 36.571429 0 0 1 36.571429 36.571428v399.213714z" fill="#666666" p-id="2251"></path></svg>`;
const alignCenterVerticallySvg = `<svg t="1725534363707" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1809" width="100%"><path d="M477.312 576V448H266.688a32 32 0 0 1-32-32v-192a32 32 0 0 1 32-32h210.624V34.688a34.688 34.688 0 0 1 69.376 0V192h210.624a32 32 0 0 1 32 32v192a32 32 0 0 1-32 32H546.688v128H896a32 32 0 0 1 32 32v192a32 32 0 0 1-32 32H546.688v157.312a34.688 34.688 0 1 1-69.376 0V832H128a32 32 0 0 1-32-32v-192A32 32 0 0 1 128 576h349.312z" fill="#666666" p-id="1810"></path></svg>`;
const alignLeftSvg = `<svg t="1725534370541" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2103" width="100%"><path d="M96 0a32 32 0 0 1 32 32v960a32 32 0 0 1-64 0V32A32 32 0 0 1 96 0z m128 192h448a32 32 0 0 1 32 32v192a32 32 0 0 1-32 32h-448a32 32 0 0 1-32-32v-192a32 32 0 0 1 32-32z m0 384h704a32 32 0 0 1 32 32v192a32 32 0 0 1-32 32h-704a32 32 0 0 1-32-32v-192a32 32 0 0 1 32-32z" fill="#666666" p-id="2104"></path></svg>`;
const alignRightSvg = `<svg t="1725534384109" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2397" width="100%"><path d="M928 0a32 32 0 0 1 32 32v960a32 32 0 0 1-64 0V32a32 32 0 0 1 32-32z m-576 192h448a32 32 0 0 1 32 32v192a32 32 0 0 1-32 32h-448a32 32 0 0 1-32-32v-192a32 32 0 0 1 32-32z m-256 384h704a32 32 0 0 1 32 32v192a32 32 0 0 1-32 32H96a32 32 0 0 1-32-32v-192A32 32 0 0 1 96 576z" fill="#666666" p-id="2398"></path></svg>`;
const alignTopSvg = `<svg t="1725534367556" class="icon" viewBox="0 0 1170 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1956" width="100%"><path d="M1170.285714 36.571429a36.571429 36.571429 0 0 1-36.571428 36.571428H36.571429a36.571429 36.571429 0 0 1 0-73.142857h1097.142857a36.571429 36.571429 0 0 1 36.571428 36.571429z m-219.428571 146.285714v512a36.571429 36.571429 0 0 1-36.571429 36.571428h-219.428571a36.571429 36.571429 0 0 1-36.571429-36.571428v-512a36.571429 36.571429 0 0 1 36.571429-36.571429h219.428571a36.571429 36.571429 0 0 1 36.571429 36.571429z m-438.857143 0v804.571428a36.571429 36.571429 0 0 1-36.571429 36.571429h-219.428571a36.571429 36.571429 0 0 1-36.571429-36.571429v-804.571428a36.571429 36.571429 0 0 1 36.571429-36.571429h219.428571a36.571429 36.571429 0 0 1 36.571429 36.571429z" fill="#666666" p-id="1957"></path></svg>`;
const horizontalDistributionSvg = `<svg t="1725534354023" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1515" width="100%"><path d="M96 0a32 32 0 0 1 32 32v960a32 32 0 0 1-64 0V32A32 32 0 0 1 96 0z m832 0a32 32 0 0 1 32 32v960a32 32 0 0 1-64 0V32a32 32 0 0 1 32-32zM384 800v-576a32 32 0 0 1 32-32h192a32 32 0 0 1 32 32v576a32 32 0 0 1-32 32h-192a32 32 0 0 1-32-32z" fill="#666666" p-id="1516"></path></svg>`;
const verticalDistributionSvg = `<svg t="1725534350231" class="icon" viewBox="0 0 1170 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1368" width="100%"><path d="M1170.285714 36.571429a36.571429 36.571429 0 0 1-36.571428 36.571428H36.571429a36.571429 36.571429 0 0 1 0-73.142857h1097.142857a36.571429 36.571429 0 0 1 36.571428 36.571429z m0 950.857142a36.571429 36.571429 0 0 1-36.571428 36.571429H36.571429a36.571429 36.571429 0 0 1 0-73.142857h1097.142857a36.571429 36.571429 0 0 1 36.571428 36.571428zM256 365.714286h658.285714a36.571429 36.571429 0 0 1 36.571429 36.571428v219.428572a36.571429 36.571429 0 0 1-36.571429 36.571428h-658.285714a36.571429 36.571429 0 0 1-36.571429-36.571428v-219.428572a36.571429 36.571429 0 0 1 36.571429-36.571428z" fill="#666666" p-id="1369"></path></svg>`;
const equalWidthSvg = `<svg t="1725606034670" class="icon" viewBox="0 0 1088 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7213" width="100%"><path d="M978.24 480a42.688 42.688 0 0 1-42.688 42.688H172.928a42.688 42.688 0 0 1-42.688-42.688V213.312c0-23.552 19.072-42.624 42.688-42.624h762.624c23.552 0 42.688 19.072 42.688 42.624V480z" fill="#666666" p-id="7214"></path><path d="M256.96 734.144c0-14.08 11.456-25.6 25.6-25.6h543.36a25.6 25.6 0 0 1 0 51.2h-543.36a25.6 25.6 0 0 1-25.6-25.6z" fill="#666666" p-id="7215"></path><path d="M136.64 745.216a12.8 12.8 0 0 1 0-22.144l184.192-106.368a12.8 12.8 0 0 1 19.2 11.072v212.736a12.8 12.8 0 0 1-19.2 11.072l-184.192-106.368zM971.84 745.216a12.8 12.8 0 0 0 0-22.144l-184.256-106.368a12.8 12.8 0 0 0-19.2 11.072v212.736a12.8 12.8 0 0 0 19.2 11.072l184.256-106.368z" fill="#666666" p-id="7216"></path></svg>`
const equalHeightSvg = `<svg t="1725606224564" class="icon" viewBox="0 0 1088 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7790" width="100%"><path d="M572.16 936a42.688 42.688 0 0 1-42.688-42.688V130.688c0-23.616 19.136-42.688 42.688-42.688h266.688c23.552 0 42.624 19.072 42.624 42.688v762.624a42.688 42.688 0 0 1-42.624 42.688H572.16z" fill="#666666" p-id="7791"></path><path d="M318.016 214.72c14.08 0 25.6 11.456 25.6 25.6v543.36a25.6 25.6 0 1 1-51.2 0v-543.36c0-14.144 11.456-25.6 25.6-25.6z" fill="#666666" p-id="7792"></path><path d="M306.944 94.4a12.8 12.8 0 0 1 22.144 0l106.368 184.192a12.8 12.8 0 0 1-11.072 19.2H211.648a12.8 12.8 0 0 1-11.072-19.2l106.368-184.192zM306.944 929.6a12.8 12.8 0 0 0 22.144 0l106.368-184.192a12.8 12.8 0 0 0-11.072-19.2H211.648a12.8 12.8 0 0 0-11.072 19.2l106.368 184.192z" fill="#666666" p-id="7793"></path></svg>`

const current_node_list = []; // 存储已选中的节点

function pollForCanvas() {
    const canvas = document.querySelector('canvas#graph-canvas');
    if (canvas) {
        // 监听左键单击事件
        canvas.addEventListener('click', function (event) {
            event.preventDefault();

            const { offsetX, offsetY } = event;

            // 获取当前的 `LGraphCanvas` 数据
            const current_node = event.target.data?.current_node;

            // 判断 `current_node` 是否存在
            if (current_node !== null && current_node !== undefined) {
                // 判断 `current_node` 是否已经在 `current_node_list` 中
                const nodeExists = current_node_list.some(node => node.id === current_node.id);
                if (!nodeExists) {
                    // 如果当前节点不存在列表中，则添加
                    current_node_list.push(current_node);
                }
            } else {
                // 如果没有选中的节点，清空列表
                current_node_list.length = 0;
                ButtonManager.hide();
            }

            const selectedNodes = current_node_list.filter(node => node.is_selected === true);

            if (selectedNodes.length >= 2) {
                ButtonManager.show();
            }
        });
    } else {
        setTimeout(pollForCanvas, 1000); // 每隔 1 秒尝试查找一次
    }
}

// 启动轮询查找
pollForCanvas();

function getTopNode(selectedNodes) {
    // 通过比较节点的 y 坐标，找到最上方的节点
    return selectedNodes.reduce((topNode, node) => (node.pos[1] < topNode.pos[1] ? node : topNode), selectedNodes[0]);
}

const ButtonManager = {
    isInitialized: false, // 检查是否已经初始化
    buttonContainer: null, // 保存按钮容器

    // 初始化按钮
    init() {
        if (this.isInitialized) return; // 如果已经初始化过，不再重复创建

        // 使用 CSS 定义 hover 效果和所有样式
        const style = document.createElement('style');
        style.textContent = `
            #alignment-buttons {
                position: absolute;
                top: 20px;
                right: 10px;
                display: flex;
                gap: 2px;
                background: #333333;
                padding: 4px;
                border-radius: 4px;
                z-index: 9999;
            }
            .custom-button {
                width: 25px;
                height: 25px;
                background-size: contain;
                background-repeat: no-repeat;
                background-position: center;
                background-color: #333333;
                border: none;
                cursor: pointer;
                padding: 4px;
                border-radius: 4px;
                transition: background-color 0.3s ease;
            }
            .custom-button:hover {
                background-color: #555555; /* 在 hover 时改变背景颜色 */
            }
            .divider {
                width: 2.5px;
                height: 15px;
                background-color: #262626;
                margin: 5px 4px;
                border-radius: 2.5px;
            }
        `;
        document.head.appendChild(style);

        // 创建按钮容器
        this.buttonContainer = document.createElement('div');
        this.buttonContainer.id = 'alignment-buttons';
        document.body.appendChild(this.buttonContainer);

        // 创建按钮并分配功能
        const buttons = this.getButtons();
        buttons.forEach(btn => {
            if (btn.type === 'divider') {
                // 创建分割线
                const divider = document.createElement('div');
                divider.classList.add('divider');
                this.buttonContainer.appendChild(divider);
            } else {
                // 创建按钮
                const button = document.createElement('button');
                button.id = btn.id;
                button.classList.add('custom-button');
                button.innerHTML = btn.svg;
                button.addEventListener('click', btn.action);
                this.buttonContainer.appendChild(button);
            }
        });

        this.isInitialized = true; // 标记已经初始化
    },

    getButtons() {
        return [
            /* 左对齐 */
            { id: 'alignLeft', svg: alignLeftSvg, action: this.alignLeft.bind(this) },
            /* 竖向居中对齐 */
            { id: 'alignCenterVertically', svg: alignCenterVerticallySvg, action: this.alignCenterVertically.bind(this) },
            /* 右对齐 */
            { id: 'alignRight', svg: alignRightSvg, action: this.alignRight.bind(this) },
            // 分割线
            { type: 'divider' },
            /* 顶部对齐 */
            { id: 'alignTop', svg: alignTopSvg, action: this.alignTop.bind(this) },
            /* 横向居中对齐 */
            { id: 'alignCenterHorizontally', svg: alignCenterHorizontallySvg, action: this.alignCenterHorizontally.bind(this) },
            /* 底部对齐 */
            { id: 'alignBottom', svg: alignBottomSvg, action: this.alignBottom.bind(this) },
            // 分割线
            { type: 'divider' },
            /* 横向分布 */
            { id: 'horizontalDistribution', svg: horizontalDistributionSvg, action: this.horizontalDistribution.bind(this) },
            /* 竖向分布 */
            { id: 'verticalDistribution', svg: verticalDistributionSvg, action: this.verticalDistribution.bind(this) },
            // 分割线
            { type: 'divider' },
            /* 等宽 */
            { id: 'equalWidth', svg: equalWidthSvg, action: this.equalWidth.bind(this) },
            /* 等高 */
            { id: 'equalHeight', svg: equalHeightSvg, action: this.equalHeight.bind(this) },
        ];
    },

    // 显示按钮
    show() {
        if (!this.isInitialized) this.init(); // 如果没有初始化，先初始化
        this.buttonContainer.style.display = 'flex'; // 显示按钮容器
    },

    // 隐藏按钮
    hide() {
        if (this.buttonContainer) {
            this.buttonContainer.style.display = 'none'; // 隐藏按钮容器
        }
    },

    // 获取当前选中的节点
    getSelectedNodes() {
        return current_node_list.filter(node => node.is_selected === true);
    },

    // 执行对齐操作的通用方法
    alignNodesByProperty(prop, value) {
        const nodes = this.getSelectedNodes();
        if (nodes.length > 0) {
            nodes.forEach(node => {
                node.pos[prop] = value;
            });
            LGraphCanvas.active_canvas.setDirty(true, true); // 重新渲染 canvas
        }
    },

    // 左对齐
    alignLeft() {
        const leftMost = Math.min(...this.getSelectedNodes().map(node => node.pos[0]));
        this.alignNodesByProperty(0, leftMost);
    },

    // 右对齐
    alignRight() {
        const rightMost = Math.max(...this.getSelectedNodes().map(node => node.pos[0] + node.size[0]));
        this.getSelectedNodes().forEach(node => {
            node.pos[0] = rightMost - node.size[0]; // 右对齐
        });
        LGraphCanvas.active_canvas.setDirty(true, true);
    },

    // 顶部对齐
    alignTop() {
        const topMost = Math.min(...this.getSelectedNodes().map(node => node.pos[1]));
        this.alignNodesByProperty(1, topMost);
    },

    // 底部对齐
    alignBottom() {
        const bottomMost = Math.max(...this.getSelectedNodes().map(node => node.pos[1] + node.size[1]));
        this.getSelectedNodes().forEach(node => {
            node.pos[1] = bottomMost - node.size[1]; // 底部对齐
        });
        LGraphCanvas.active_canvas.setDirty(true, true);
    },

    // 水平居中对齐
    alignCenterHorizontally() {
        const centerY = this.calculateCenter(1);
        this.getSelectedNodes().forEach(node => {
            node.pos[1] = centerY - node.size[1] / 2; // 垂直居中
        });
        LGraphCanvas.active_canvas.setDirty(true, true);
    },

    // 垂直居中对齐
    alignCenterVertically() {
        const centerX = this.calculateCenter(0);
        this.getSelectedNodes().forEach(node => {
            node.pos[0] = centerX - node.size[0] / 2; // 水平居中
        });
        LGraphCanvas.active_canvas.setDirty(true, true);
    },

    // 计算节点的中心坐标
    calculateCenter(axis) {
        const nodes = this.getSelectedNodes();
        const min = Math.min(...nodes.map(node => node.pos[axis]));
        const max = Math.max(...nodes.map(node => node.pos[axis] + node.size[axis]));
        return (min + max) / 2;
    },

    // 横向分布
    horizontalDistribution() {
        this.distributeNodes(0);
    },

    // 纵向分布
    verticalDistribution() {
        this.distributeNodes(1);
    },

    // 等宽
    equalWidth() {
        this.equalSize(0);
    },

    // 等高
    equalHeight() {
        this.equalSize(1);
    },

    // 通用的节点尺寸调整
    equalSize(axis) {
        const nodes = this.getSelectedNodes();
        if (nodes.length > 0) {
            const averageSize = (nodes.reduce((sum, node) => sum + node.size[axis], 0) / nodes.length).toFixed(2);
            nodes.forEach(node => {
                node.size[axis] = parseFloat(averageSize); // 设置所有节点的大小为平均值
            });
            LGraphCanvas.active_canvas.setDirty(true, true);
        }
    },

    // 通用的节点分布方法
    distributeNodes(axis) {
        const nodes = this.getSelectedNodes();
        if (nodes.length > 1) {
            const min = Math.min(...nodes.map(node => node.pos[axis]));
            const max = Math.max(...nodes.map(node => node.pos[axis] + node.size[axis]));
            const totalSize = nodes.reduce((sum, node) => sum + node.size[axis], 0);
            const spacing = (max - min - totalSize) / (nodes.length - 1);
            let current = min;
            nodes.forEach(node => {
                node.pos[axis] = current;
                current += node.size[axis] + spacing;
            });
            LGraphCanvas.active_canvas.setDirty(true, true);
        }
    }
};
